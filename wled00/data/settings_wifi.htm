<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport">
	<title data-i18n="wifiSettingsTitle">WiFi 设置</title>
	<script src="common.js" type="text/javascript"></script>
	<script>
		var scanLoops = 0, preScanSSID = "";
		var maxNetworks = 3;
		function N() {
			const button = gId("scan");
			button.disabled = true;
			button.textContent = t('scanning');

			fetch(getURL("/json/net")).then((response) => {
				return response.json();
			}).then((json) => {
				// Get the list of networks only, defaulting to an empty array.
				return Object.assign(
					{},
					{"networks": []},
					json,
				).networks.sort(
					// Sort by signal strength, descending.
					(a, b) => b.rssi - a.rssi
				).reduce(
					// Filter out duplicate SSIDs. Since it is sorted by signal
					// strength, the strongest signal will be kept in the
					// order it as originally appeared in the array.
					(unique, other) => {
						if(!unique.some(obj => obj.ssid === other.ssid)) {
							unique.push(other);
						}
						return unique;
					},
					[],
				);
			}).then((networks) => {
				// If there are no networks, fetch it again in a second.
				// but only do this a few times.
				if (networks.length === 0 && scanLoops < 10) {
					scanLoops++;
					setTimeout(N, 1000);
					return;
				}
				scanLoops = 0;

				if (networks.length > 0) {
					let cs = d.querySelectorAll("#wifi_entries input[type=text][name^=CS]");
					for (let input of (cs||[])) {
						let found = false;
						let select = cE("select");
						select.id = input.id;
						select.name = input.name;
						select.setAttribute("onchange", "T(this)");
						preScanSSID = input.value;

						for (let i = 0; i < select.children.length; i++) {
							select.removeChild(select.children[i]);
						}

						for (let i = 0; i < networks.length; i++) {
							const option = cE("option");

							option.setAttribute("value", networks[i].ssid);
							option.textContent = `${networks[i].ssid} (${networks[i].rssi} dBm)`; // [${networks[i].bssid.replaceAll(':','')}]

							if (networks[i].ssid === input.value) {
								option.setAttribute("selected", "selected");
								found = true;
							}

							select.appendChild(option);
						}
						const option = cE("option");

						option.setAttribute("value", "!Cs");
						option.textContent = t('otherNetwork');
						select.appendChild(option);

						if (input.value === "" || input.value === "Your_Network" || found) input.replaceWith(select);
						else select.remove(); 
					}
				}

				button.disabled = false;
				button.textContent = t('scan');
			});
		}
		// replace WiFi select with custom SSID input field again
		function T(cs) {
			if (!cs || cs.value != "!Cs") return;
			let input = cE("input");
			input.type = "text";
			input.id = cs.id;
			input.name = cs.name;
			input.setAttribute("maxlength",32);
			input.value = preScanSSID;
			cs.replaceWith(input);
		}
		function resetWiFi(maxN = undefined) {
			if (maxN) maxNetworks = maxN;
			let entries = gId("wifi_entries").children
			for (let i = entries.length; i > 0; i--) entries[i-1].remove();
			btnWiFi(0);
		}
		function btnWiFi(i) {
			gId("wifi_add").style.display = (i<maxNetworks) ? "inline":"none";
			gId("wifi_rem").style.display = (i>1) ? "inline":"none";
		}
		function addWiFi(ssid="",pass="",bssid="",ip=0,gw=0,sn=0x00ffffff) { // little endian
			var i = gId("wifi_entries").childNodes.length;
			if (i >= maxNetworks) return;
			var leaveEmptyText = i==0 ? '<span data-i18n="leaveEmptyToDisconnect"></span>' : '';
			var ethernetText = i==0 ? '<span data-i18n="alsoForEthernet"></span>' : '';
			var b = `<div id="net${i}"><hr class="sml">
<span data-i18n="networkName">网络名称 (SSID</span>${leaveEmptyText}):<br><input type="text" id="CS${i}" name="CS${i}" maxlength="32" value="${ssid}" ${i>0?"required":""}><br>
<span data-i18n="networkPassword">网络密码</span>:<br><input type="password" name="PW${i}" maxlength="64" value="${pass}"><br>
<span data-i18n="bssidOptional">BSSID (可选)</span>:<br><input type="text" id="BS${i}" name="BS${i}" maxlength="12" value="${bssid}"><br>
<span data-i18n="staticIP">静态IP (保持0.0.0.0使用DHCP)</span>${ethernetText}:<br>
<input name="IP${i}0" type="number" class="s" min="0" max="255" value="${ip&0xFF}" required>.<input name="IP${i}1" type="number" class="s" min="0" max="255" value="${(ip>>8)&0xFF}" required>.<input name="IP${i}2" type="number" class="s" min="0" max="255" value="${(ip>>16)&0xFF}" required>.<input name="IP${i}3" type="number" class="s" min="0" max="255" value="${(ip>>24)&0xFF}" required><br>
<span data-i18n="staticGateway">静态网关</span>:<br>
<input name="GW${i}0" type="number" class="s" min="0" max="255" value="${gw&0xFF}" required>.<input name="GW${i}1" type="number" class="s" min="0" max="255" value="${(gw>>8)&0xFF}" required>.<input name="GW${i}2" type="number" class="s" min="0" max="255" value="${(gw>>16)&0xFF}" required>.<input name="GW${i}3" type="number" class="s" min="0" max="255" value="${(gw>>24)&0xFF}" required><br>
<span data-i18n="staticSubnetMask">静态子网掩码</span>:<br>
<input name="SN${i}0" type="number" class="s" min="0" max="255" value="${sn&0xFF}" required>.<input name="SN${i}1" type="number" class="s" min="0" max="255" value="${(sn>>8)&0xFF}" required>.<input name="SN${i}2" type="number" class="s" min="0" max="255" value="${(sn>>16)&0xFF}" required>.<input name="SN${i}3" type="number" class="s" min="0" max="255" value="${(sn>>24)&0xFF}" required></div>`;
			gId("wifi_entries").insertAdjacentHTML("beforeend", b);
			btnWiFi(i+1);
			// Apply translations to newly added elements
			if (typeof applyTranslations === 'function') applyTranslations();
		}
		function remWiFi() {
			const entries = gId("wifi_entries").children;
			const i = entries.length;
			if (i < 2) return;
			entries[i-1].remove();
			btnWiFi(i-1);
		}
		function S() {
			getLoc();
			// 初始化语言切换按钮
			initLangToggle();
			// 应用翻译
			applyTranslations();
			// 更新title标签
			var titleEl = d.querySelector('title[data-i18n]');
			if (titleEl) {
				var key = titleEl.getAttribute('data-i18n');
				if (typeof t === 'function') {
					titleEl.textContent = t(key);
				}
			}
			loadJS(getURL('/settings/s.js?p=1'), false);	// If we set async false, file is loaded and executed, then next statement is processed
			if (loc) d.Sf.action = getURL('/settings/wifi');
			setTimeout(tE, 500); // wait for DOM to load before calling tE()
		}

		var rC = 0; // remote count
		// toggle visibility of ESP-NOW remote list based on checkbox state
		function tE() {
			// keep the hidden input with MAC addresses, only toggle visibility of the list UI
			gId('rlc').style.display = d.Sf.RE.checked ? 'block' : 'none';
		}
		// reset remotes: initialize empty list (called from xml.cpp)
		function rstR() {
			gId('rml').innerHTML = ''; // clear remote list
		}
		// add remote MAC to the list
		function aR(id, mac) {
			if (!/^[0-9A-F]{12}$/i.test(mac)) return; // check for valid hex string
			let inputs = d.querySelectorAll("#rml input");
			for (let i of (inputs || [])) {
				if (i.value === mac) return;
			}
			let l = gId('rml'), r = cE('div'), i = cE('input');
			i.type = 'text';
			i.name = id;
			i.value = mac;
			i.maxLength = 12;
			i.minLength = 12;
			//i.onchange = uR;
			r.appendChild(i);
			let b = cE('button');
			b.type = 'button';
			b.className = 'sml';
			b.innerText = '-';
			b.onclick = (e) => {
 				r.remove();
 			};
			r.appendChild(b);
			l.appendChild(r);
			rC++;
			gId('+').style.display = gId("rml").childElementCount < 10 ? 'inline' : 'none'; // can't append to list anymore, hide button
		}

	</script>
	<style>@import url("style.css");</style>
</head>
<body onload="S()">
  <form id="form_s" name="Sf" method="post">
		<div class="toprow">
		<div class="helpB"><button type="button" onclick="H('features/settings/#wifi-settings')">?</button></div>
		<button type="button" onclick="B()" data-i18n="back">返回</button><button type="submit" data-i18n="saveAndConnect">保存并连接</button>
		<button type="button" id="langToggle" onclick="toggleLanguage()" style="background: rgba(255,255,255,0.1); border: none; color: var(--c-t); padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; margin-left: 8px;">EN</button>
		<hr>
		</div>
		<h2 data-i18n="wifiSettingsTitle">WiFi 设置</h2>
		<h3 data-i18n="connectToNetwork">连接到现有网络</h3>
		<button type="button" id="scan" onclick="N()" data-i18n="scan">扫描</button><br>
		<div id="wifi">
			<span data-i18n="wirelessNetworks">无线网络</span>
			<div id="wifi_entries"></div>
			<hr class="sml">
			<button type="button" id="wifi_add" onclick="addWiFi()">+</button>
			<button type="button" id="wifi_rem" onclick="remWiFi()">-</button><br>
		</div>
		<span data-i18n="dnsServerAddress">DNS服务器地址</span>:<br>
		<input name="D0" type="number" class="s" min="0" max="255" required>.<input name="D1" type="number" class="s" min="0" max="255" required>.<input name="D2" type="number" class="s" min="0" max="255" required>.<input name="D3" type="number" class="s" min="0" max="255" required><br>
		<br>
		<span data-i18n="mdnsAddress">mDNS地址 (留空则不使用mDNS)</span>:<br>
		http:// <input type="text" name="CM" maxlength="32"> .local<br>
		<span data-i18n="clientIP">客户端IP</span>: <span class="sip" data-i18n="notConnected"> 未连接 </span> <br>
		<h3 data-i18n="configureAP">配置接入点</h3>
		<span data-i18n="apSSID">接入点SSID (留空则不启用AP)</span>:<br> <input type="text" name="AS" maxlength="32"><br>
		<span data-i18n="hideAPName">隐藏AP名称</span>: <input type="checkbox" name="AH"><br>
		<span data-i18n="apPassword">AP密码 (留空则为开放网络)</span>:<br> <input type="password" name="AP" maxlength="63" pattern="(.{8,63})|()" title="留空或至少8个字符"><br>
		<span data-i18n="apWiFiChannel">接入点WiFi信道</span>: <input name="AC" type="number" class="xs" min="1" max="13" required><br>
		<span data-i18n="apStartCondition">AP开启条件</span>:
		<select name="AB">
			<option value="0" data-i18n="apStartNoConnection">启动后无连接时</option>
			<option value="1" data-i18n="apStartDisconnected">断开连接时</option>
			<option value="2" data-i18n="apStartAlways">始终开启</option>
			<option value="3" data-i18n="apStartNever">永不开启 (不推荐)</option>
			<option value="4" data-i18n="apStartTemporary">临时 (启动后无连接时)</option>
		</select><br>
		<span data-i18n="apIP">AP IP</span>: <span class="sip" data-i18n="notActivated"> 未激活 </span><br>
		<h3 data-i18n="experimentalFeatures">实验性功能</h3>
		<span data-i18n="force80211g">强制802.11g模式 (仅ESP8266)</span>: <input type="checkbox" name="FG"><br>
		<span data-i18n="disableWiFiSleep">禁用WiFi休眠</span>: <input type="checkbox" name="WS"><br>
		<i data-i18n="helpConnectionIssues">有助于解决连接问题和音频反应同步。<br>
		<span data-i18n="disableWiFiSleepIncreases">禁用WiFi休眠会增加功耗。</span></i><br>
		<div id="tx"><span data-i18n="transmitPower">发射功率</span>: <select name="TX">
			<option value="78">19.5 dBm</option>
			<option value="76">19 dBm</option>
			<option value="74">18.5 dBm</option>
			<option value="68">17 dBm</option>
			<option value="60">15 dBm</option>
			<option value="52">13 dBm</option>
			<option value="44">11 dBm</option>
			<option value="34">8.5 dBm</option>
			<option value="28">7 dBm</option>
			<option value="20">5 dBm</option>
			<option value="8">2 dBm</option>
		</select><br>
		<i class="warn" data-i18n="transmitPowerWarning">警告: 修改发射功率可能导致设备无法访问。</i>
		</div>

		<h3 data-i18n="espnowWireless">ESP-NOW 无线</h3>
		<div id="NoESPNOW" class="hide">
			<i class="warn" data-i18n="firmwareNoESPNOW">此固件版本不包含ESP-NOW支持。<br></i>
		</div>
		<div id="ESPNOW">
			<span data-i18n="enableESPNOW">启用ESP-NOW</span>: <input type="checkbox" name="RE" onchange="tE()"><br>
			<i data-i18n="listenViaESPNOW">通过ESP-NOW监听事件<br>
			<span data-i18n="keepDisabledIfNotUsed">如果不使用遥控器或ESP-NOW同步，请保持禁用，会增加功耗。</span><br></i>
			<div id="rlc">
				<span data-i18n="lastSeenDevice">最后看到的设备</span>: <span class="rlid" id="ld" data-i18n="none">无</span>
				<button type="button" class="sml" id="+" onclick="aR('RM'+rC,gId('ld').textContent)">+</button><br>
				<span data-i18n="linkedMACAddresses">已链接MAC地址 (最多10个)</span>:<br>
				<div id="rml">
				</div>
			</div>
		</div>

		<div id="ethd">
			<h3 data-i18n="ethernetType">以太网类型</h3>
			<select name="ETH">
				<option value="0" data-i18n="none">无</option>
				<option value="6">IoTorero/ESP32Deux/RGB2Go</option>
				<option value="9">ABC! WLED V43 & Compatible</option>
				<option value="2">ESP32-POE</option>
				<option value="11">ESP32-POE-WROVER</option>
				<option value="7">KIT-VE</option>
				<option value="12">LILYGO T-POE Pro</option>
				<option value="8">QuinLED-Dig-Octa & T-ETH-POE</option>
				<option value="4">QuinLED-ESP32</option>
				<option value="10">Serg74-ETH32</option>
				<option value="5">TwilightLord-ESP32</option>
				<option value="3">WESP32</option>
				<option value="1">WT32-ETH01</option>
			</select><br><br>
		</div>
		<hr>
		<button type="button" onclick="B()" data-i18n="back">返回</button><button type="submit" data-i18n="saveAndConnect">保存并连接</button>
	</form>
</body>
</html>
