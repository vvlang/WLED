name: Auto Build Firmware

on:
  # 手动触发
  workflow_dispatch:
    inputs:
      build_web_ui:
        description: 'Build web UI first'
        required: true
        default: true
        type: boolean
  # Push到main分支时自动编译esp32c3dev
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'
      - '.github/**'
  
  # 只编译ESP32-C3，移除其他环境的选项

jobs:
  build:
    name: Build ESP32-C3
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install npm dependencies
        run: npm ci

      - name: Update version
        run: |
          VERSION=`date +%y%m%d0`
          sed -i -r -e "s/define VERSION .+/define VERSION $VERSION/" wled00/wled.h

      - name: Build web UI
        if: ${{ github.event.inputs.build_web_ui != false }}
        run: npm run build

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install PlatformIO
        run: pip install -r requirements.txt

      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: |
            ~/.platformio/.cache
            ~/.buildcache
            build_output
          key: pio-${{ runner.os }}-esp32c3dev-${{ hashFiles('platformio.ini', 'pio-scripts/output_bins.py') }}-${{ hashFiles('wled00/**', 'usermods/**') }}
          restore-keys: |
            pio-${{ runner.os }}-esp32c3dev-${{ hashFiles('platformio.ini', 'pio-scripts/output_bins.py') }}-

      - name: Build firmware
        run: pio run -e esp32c3dev

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware-esp32c3dev
          path: |
            build_output/release/*.bin
          retention-days: 30

      - name: Get firmware info
        id: firmware_info
        run: |
          FIRMWARE_FILE=$(find build_output/release -name "*.bin" -type f | head -n 1)
          if [ -n "$FIRMWARE_FILE" ]; then
            FIRMWARE_SIZE=$(du -h "$FIRMWARE_FILE" | cut -f1)
            echo "file=$FIRMWARE_FILE" >> $GITHUB_OUTPUT
            echo "size=$FIRMWARE_SIZE" >> $GITHUB_OUTPUT
            echo "name=$(basename $FIRMWARE_FILE)" >> $GITHUB_OUTPUT
          fi

      - name: Get version number
        id: version
        run: |
          VERSION=$(grep -E "^#define VERSION" wled00/wled.h | awk '{print $3}')
          # 将版本号转换为日期格式 (yymmddb -> vYY.MM.DD-b)
          YEAR=$((2000 + ${VERSION:0:2}))
          MONTH=${VERSION:2:2}
          DAY=${VERSION:4:2}
          BUILD=${VERSION:6:1}
          VERSION_TAG="v${YEAR}.${MONTH}.${DAY}-${BUILD}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$VERSION_TAG" >> $GITHUB_OUTPUT
          echo "name=WLED ${YEAR}.${MONTH}.${DAY} (Build ${BUILD})" >> $GITHUB_OUTPUT

      - name: Check if release exists
        id: check_release
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          REPO="${{ github.repository }}"
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO/releases/tags/$TAG")
          
          if [ "$RESPONSE" = "200" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Release $TAG already exists, will update it"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Release $TAG does not exist, will create it"
          fi

      - name: Get existing release body
        id: existing_body
        if: steps.check_release.outputs.exists == 'true'
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          REPO="${{ github.repository }}"
          BODY=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO/releases/tags/$TAG" | jq -r '.body')
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Prepare release body
        id: release_body
        run: |
          ENV_NAME="esp32c3dev"
          VERSION="${{ steps.version.outputs.version }}"
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_MSG="${{ github.event.head_commit.message || 'Auto build' }}"
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          if [ "${{ steps.check_release.outputs.exists }}" == "true" ]; then
            EXISTING_BODY="${{ steps.existing_body.outputs.body }}"
            {
              echo 'body<<RELEASE_BODY_EOF'
              echo "$EXISTING_BODY"
              echo ""
              echo "### $ENV_NAME"
              echo "- **编译时间**: $TIMESTAMP"
              echo "- **提交**: \`$COMMIT_SHA\`"
              echo "- **提交信息**: $COMMIT_MSG"
              echo 'RELEASE_BODY_EOF'
            } >> $GITHUB_OUTPUT
          else
            {
              echo 'body<<RELEASE_BODY_EOF'
              echo "## WLED 固件发布"
              echo ""
              echo "**版本号**: \`$VERSION\`"
              echo "**编译时间**: $TIMESTAMP"
              echo ""
              echo "## 支持的平台"
              echo ""
              echo "### $ENV_NAME"
              echo "- **编译时间**: $TIMESTAMP"
              echo "- **提交**: \`$COMMIT_SHA\`"
              echo "- **提交信息**: $COMMIT_MSG"
              echo ""
              echo "## 下载"
              echo ""
              echo "请下载对应您设备平台的固件文件。"
              echo ""
              echo "---"
              echo ""
              echo "*此版本由GitHub Actions自动编译生成*"
              echo 'RELEASE_BODY_EOF'
            } >> $GITHUB_OUTPUT
          fi

      - name: Create or Update Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ steps.version.outputs.name }}
          body: ${{ steps.release_body.outputs.body }}
          files: |
            build_output/release/*.bin
          draft: false
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build summary
        run: |
          echo "## 固件编译完成 ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**环境**: esp32c3dev" >> $GITHUB_STEP_SUMMARY
          echo "**版本号**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release标签**: ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**固件文件**: ${{ steps.firmware_info.outputs.name }}" >> $GITHUB_STEP_SUMMARY
          echo "**文件大小**: ${{ steps.firmware_info.outputs.size }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ 固件已自动发布到 [Releases](${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }})" >> $GITHUB_STEP_SUMMARY

